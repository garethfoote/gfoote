{%- comment -%}
*
* MIT License
* Copyright (c) 2020 Raghuveer S, Hiran Venugopalan
*
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
*
* File: Content.html
* Author Raghuveer S, Hiran Venugopalan
*
* This file contains the markup for the context menu thingy you see when you right
* click on the post titles on the home page.
*
{%- endcomment -%}


<!-- Parse internal links, external links, transclusions etc and manipuate the content to reflect it accordingly -->
{%- assign link_joiner_delimiter = '$@' -%}
{%- assign image_array = content | split:'![[' -%}
{%- for item in image_array -%}
    {%- if forloop.index > 1 -%}
        {%- assign itemparts = item | split:']]' -%}
        {%- assign wikiimage_title = itemparts[0] -%}
        {%- assign file = "" -%}  
        {% for f in site.static_files %} 
          {% if f.name == wikiimage_title or f.path contains wikiimage_title %}
          {%- assign file = f  -%}  
          {% endif %}
        {% endfor %}
        {%- assign wikiimage_titles = wikiimage_titles | append: link_joiner_delimiter | append: wikiimage_title -%}
        {%- assign wikiimage_urls = wikiimage_urls | append: link_joiner_delimiter | append: file.path -%}

    {%- endif -%}
{%- endfor -%}

{%- assign image_titles_array = wikiimage_titles | split:link_joiner_delimiter -%}
{%- assign image_url_array = wikiimage_urls | split:link_joiner_delimiter -%}

{%- assign replaced_content = content -%}
{%- for image_title in image_titles_array -%}
  {%- assign image_url = image_url_array[forloop.index0] -%}

  {%- if image_url != nil and url != empty -%}
    {%- assign link_text = '<img src="'| append: site.baseurl | append: image_url | append: '" />' -%}
    {%- assign bracket_link = '![[' | append: image_title | append: ']]' -%}
    {%- assign replaced_content = replaced_content | replace: bracket_link,link_text -%}
  {%- endif -%}
{%- endfor -%}


{%- assign links_array = content | split:'[[' -%}
{%- for item in links_array -%}
    {%- if forloop.index > 1 -%}
        {%- assign itemparts = item | split:']]' -%}
        {%- assign wikilink_title = itemparts[0] -%}

        {%- comment -%}
        {% for file in  site.static_files %} 
            {% if file.name == itemparts[0] %}
            {%- assign attachment = file  -%}  
            {% endif %}
        {% endfor %}
        {%- endcomment -%}

        {%- assign result_topics = site.topics | where: 'title',itemparts[0] -%}  
        {%- assign result_writing = site.writing | where: 'title',itemparts[0] -%}  
        {%- assign result_posts = site.posts | where: 'title',itemparts[0] -%}  
        {%- assign result_notes = site.notes | where: 'title',itemparts[0] -%}
        {%- assign result_pages = site.pages | where: 'title',itemparts[0] -%}
        {%- assign wikilink_titles = wikilink_titles | append: link_joiner_delimiter | append: wikilink_title -%}
        {%- assign wikilink_urls = wikilink_urls | append: link_joiner_delimiter | append: result_posts[0].url | append: result_pages[0].url | append: result_notes[0].url | append: result_writing[0].url  | append: result_topics[0].url -%}

    {%- endif -%}
{%- endfor -%}

{%- assign internal_url_array = wikilink_urls | split:link_joiner_delimiter -%}
{%- assign internal_link_array = wikilink_titles | split:link_joiner_delimiter -%}

{%- for title in internal_link_array -%}
    {%- assign url = internal_url_array[forloop.index0] -%}
    {%- if url == nil or url == empty -%}
        {%- assign link_text = '<span class="tooltip"><a class="stale-link" href="' | append: 'javascript:void(0)' | append: '">' | append: title | append: '</a> <span class="right bottom"> <span class="tooltip-title">' | append: {{site.privatelinks.title}} | append: '</span><br/><span class="tooltip-excerpt">' | append: {{site.privatelinks.msg}} | append : ' <br/></span> </span></span>' -%}
    {%- else -%}

      {%- assign link_text = '<a href="'| append: site.baseurl | append: url | append: '">' | append: title | append: '</a>' -%}
    {%- endif -%}
    {%- assign bracket_link = '[[' | append: title | append: ']]' -%}
    {%- assign replaced_content = replaced_content | replace: bracket_link,link_text -%}
{%- endfor -%}

{{ replaced_content }}

